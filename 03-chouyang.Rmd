# 统计学与R语言

```{r setup}
require(tidyverse)
require(readxl)
require(ggthemr)
require(TeachingDemos)
ggthemr('light', spacing = 0.5, type = 'inner')
# 读入excel文件
exams03 <- read_excel("data/exams_results.xlsx")


```


## 随机数与抽样模拟

### 一元随机数


#### 均匀分布随机数

```{r}
# 生成5个处于[10,20]区间均匀分布的随机数
runif(n = 5, min = 10, max = 20 )

# 生成5个[0,1]区间的均匀分布的随机数
runif(5)

# 生成10个[0,100]的整数
round(runif(10,0,100),0)

# set.seed用来设置生成随机数的种子
# 种子相同，生成的随机数相同
set.seed(100)
runif(5)
```


#### 正态分布随机数

```{r}
# 生成10个均值为10，标准差为5的，服从正态分布的随机数
rnorm(n = 10,mean = 10,sd = 5) 

# 生成20个服从标准正态分布的随机数
set.seed(1)
rnorm(20) %>% hist

```

#### 指数分布随机数


```{r}
b03 <- rexp(100, 1/10)
hist(b03, probability = TRUE)
curve(dexp(x, 1/10), add = TRUE)
```
## 随机抽样

### 放回抽样与无放回抽样

模拟抛硬币10次, Z为正面，F为反面。

```{r}
sample(c("Z","F"), 10, replace = TRUE)
```

模拟掷骰子10次

```{r}
sample(1:6, 10, replace = TRUE)
```

模拟掷两颗骰子

```{r}
dice = as.vector(outer(1:6,1:6,paste))
sample(dice, 5, replace = TRUE)
```

### bootstrap重抽样

在原始数据范围内做有放回的再抽样，样本量仍为n，原始数据中的每个观察单位每次被抽到的概率相等，为1/n，所得样本为bootstrap样本。

下面用bootstrap对exams03数据集中语文成绩进行随机抽样：

```{r}
head(exams03)
sample(exams03$语文, 10, replace = TRUE)
```


## 统计模拟

用函数来模拟

二项分布模拟、均匀分布模拟 和 正态分布模拟

```{r}
# 构建泛式函数sim.fun

sim.fun <- function(m, f, ... ){
  sample <- 1:m
  for (i in 1:m ) {
    sample[i] <- f(...)
  }
  sample
}

# 二项分布
f <- function(n = 10, p = 0.5) {
  s = rbinom(1, n, p)
  (s-n*p)/sqrt(n*p*(1-p))
}
x <- sim.fun(1000,f)
hist(x, probability = TRUE)

# 均匀分布模拟
f <- function(n = 10){
  mean(runif(n)-1/2) / (1/sqrt(12*n))
}
x <- sim.fun(1000, f)
hist(x, probability = TRUE)

#　正态分布模拟
f <- function(n = 10, mu = 0, sigma = 1) {
  r=rnorm(n, mu, sigma)
  (mean(r)-mu) / (sigma/sqrt(n))
}
x <- sim.fun(1000, f)
hist(x, breaks = 10, probability = TRUE)
```



## 参数假设检验

### 假设检验的基本步骤

例子：假设某厂生产零件，直径均值为5cm，标准差为1cm，假设服从正态分布，标准差是1cm，经检验员抽样检查，如何判断均值是否就是5cm？

建立假设：

- 原假设$H_0$：直径为5cm，$\mu=\mu_0=5$
- 备择假设$H_1$：$\mu \neq \mu = 5$

构建统计量：

$$\mu = \frac{\overline{X}-\mu_0}{\sigma/\sqrt{n}}$$
若$\mu$落在$-1.96<\mu<1.96$，则落在接受区域，不能拒绝原假设。反之，拒绝原假设。


```{r}
# 样本
samp <- c(4.89,4.46,5.99,4.5,5.89,6.97,
          6.22,5.39,4.79,4.56,5.47,5.03,
          4.5,2.54,6.61,5.27,4.25,
          4.48,6.67,4.05)

# 检验函数
u.test <- function(a, mu, sigma) {
  se <- sigma/sqrt(length(a))
  u <- (mean(a) - mu) /se
  p <- 2*(1 - pnorm(abs(u)))
  return(list(u=u, p=p))
}
u.test(samp, 5, 1)
z.test(samp,mu = 5,stdev = 1)
```


判断：p-value大于0.05，不能拒绝原假设，认为生产的零件符合直径是5cm。


```{r}
plot_area <- function(min,max){
  function(x){
    y <- dnorm(x)
    y[x<min | x>max] <-NA
    return(y)
  }
}

krup.dnorm_area <- function(min = -Inf,max = Inf,mean = 0, sd = 1){
  function(x){
    y <- dnorm(x , mean, sd)

    y[x<min | x>max] <- NA
    return(y)
  }
}

ggplot(NULL,aes(samp)) + # geom_histogram() +
  stat_function(fun=plot_area(-Inf, -1.96), geom="area", fill="red", alpha=0.2) +  
  stat_function(fun=plot_area(1.96, Inf), geom="area", fill="red", alpha=0.2) +
  stat_function(fun=plot_area(-1, 1), geom="area", fill="#ffccdd", alpha=0.2) +
  stat_function(fun=dnorm) +
  geom_text(aes(y=0.2, x=0), label="70",parse = TRUE) +
  geom_text(aes(y=0.025, x=-2),label="2.5%") +
  geom_text(aes(y=0.025, x=2),label="2.5%")

myfun <- function(min = -3, max = 3){
  function(x){
    y <- dnorm(x)
    y[x<min | x>max] <- NA
    return(y)
  }
}

dnorm2 <- function(min,max,mean = 0, sd = 1){
    function(x){
      y <- dnorm(x,mean,sd)
      y[x< min | x>max] <- NA
      return(y)
    }
}
samp.left <- z.test(samp,5,1)$conf.int[1]
samp.right <- z.test(samp,5,1)$conf.int[2]
ggplot(NULL, aes(x = samp)) +
  stat_function(fun=dnorm2(-Inf, samp.left, 5, 1), geom="area", fill="red", alpha=0.2) +  
  stat_function(fun=dnorm2(samp.right, Inf, 5, 1),  geom="area", fill="red", alpha=0.2) +
  stat_function(fun = dnorm,args = list(mean = 5, sd = 1),aes(x = -4:8, color = "标准")) + 
  geom_vline(xintercept = z.test(samp,5, 1)$statistic) +
  scale_colour_manual("Lgend title", values = c("red", "blue"))

```



### 单样本均值检验

```{r}
conf.int <- function(x,sigma,alpha){
  mean = mean(x)
  n=length(x)
  z = qnorm(1 - alpha/2, mean - 0, sd = 1, lower.tail = TRUE)
  conf <- c(mean = sigma*z/sqrt(n), mean + sigma*z / sqrt(n))
  return(list(conf = conf, z = z))
}


conf.int(samp, 1, 0.05)
z.test(samp, 5, 1)
```

```{r test}

ztplot <- function(sample, mu, sd = 1, alter = "both"){
  sample <- samp
  mu <- 5
  sd <- 1
  mean = sample
  dnorm2 <- function(min,max,mean = 0, sd = 1){
      function(x){
        y <- dnorm(x,mean,sd)
        y[x< min | x>max] <- NA
        return(y)
      }
  }
  samp.left <- z.test(sample,mean,sd)$conf.int[1]
  samp.right <- z.test(sample,mean,sd)$conf.int[2]
  p <- ggplot(NULL, aes(x = sample))
  p <- p + stat_function(fun = dnorm2(-Inf, samp.left, mean, sd), geom="area", fill="red", alpha=0.2)
  p <- p + stat_function(fun = dnorm2(samp.right, Inf, mean, sd), geom="area", fill="red", alpha=0.2) 
  p <- p + stat_function(fun = dnorm,args = list(mean = mean, sd = sd),aes(x = c(samp.left:samp.right), color = "标准"))  
  #p <- p + geom_vline(xintercept = z.test(sample,mean, sd)$statistic)
  p <- p + geom_vline(xintercept = mu) 
  p <- p + scale_colour_manual("Lgend title", values = c("red", "blue"))
  
  print(p)
}

x<-c(175,176,173,175,174,173,173,176,173,179)

#z.test(x,10,1.5,0.05)
test <- rnorm(n = 100,sd = 1,mean = 0)
ztplot(samp, 5, sd = 1)
z.test(test,0,1)
```



### 单样本方差方差检验

### 双样本均值检验

### 双样本方差检验

### 单样本比例检验

### 双样本比例检验




## 非参数假设检验

### 图示法

### 卡方检验
### 秩和检验
### K-s检验
### 常用正态性检验
### 其他常用正态检验

## 方差分析

### 单因素方差分析
### 双因素方差分析
#### 不考虑交互作用的双因素方差分析
#### 考虑交互作用的双因素方差分析
